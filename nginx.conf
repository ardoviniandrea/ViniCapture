events {}

http {
    include /etc/nginx/mime.types;

    access_log /dev/stdout;
    error_log /dev/stderr info;

    types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
    }

    # Upstream for the KasmVNC web server
    upstream kasmvnc {
        server 127.0.0.1:6901;
    }

    # Server 1: The All-in-One UI (Port 80)
    server {
        listen 80;
        
        location /api/ {
            proxy_pass http://127.0.0.1:3000;
        }

        # --- FINAL FIX ---
        # The KasmVNC upstream listens on HTTPS by default, even with -sslOnly=0.
        # We need to tell Nginx to use HTTPS for the proxy connection.
        location /vnc/ {
            # 1. Change proxy_pass to use 'https'
            proxy_pass https://kasmvnc/; # Note the trailing slash
            
            # 2. Tell Nginx to not worry about the self-signed certificate
            proxy_ssl_verify off;

            # WebSocket proxy settings
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Serve the static UI files
        location / {
            root /usr/src/app/public;
            try_files $uri /index.html;
        }
    }

    # Server 2: The HLS Stream (Port 8994)
    server {
        listen 8994;

        location / {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
        }
    }
}
