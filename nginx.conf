events {}

http {
    # === FIX 4 ===
    # Include the default MIME types, otherwise Nginx won't know
    # what text/html, text/css, etc. are. This fixes the
    # "page shows HTML code as plain text" issue.
    include /etc/nginx/mime.types;

    # --- DEBUG: Add verbose logging ---
    access_log /dev/stdout;
    # Note: 'debug' level requires nginx to be built with --with-debug
    # We'll use 'info' as a safer bet, but change to 'debug' if 'info' isn't enough
    error_log /dev/stderr info;

    # Define HLS/DASH MIME types (these will be added to the defaults)
    types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
    }

    # Upstream for the KasmVNC web server
    upstream kasmvnc {
        server 127.0.0.1:6901;
    }

    # Server 1: The All-in-One UI (Port 80)
    server {
        listen 80;
        
        # Proxy API requests to our Node.js app
        location /api/ {
            proxy_pass http://127.0.0.1:3000;
        }

        # Proxy requests for the VNC session to the KasmVNC upstream
        # This will handle both the webpage AND the WebSockets
        location /vnc/ {
            proxy_pass http://kasmvnc/; # Note the trailing slash
            
            # WebSocket proxy settings
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Serve the static UI files
        location / {
            # The root path must match the Dockerfile's WORKDIR
            root /usr/src/app/public;
            try_files $uri /index.html;
        }
    }

    # Server 2: The HLS Stream (Port 8994)
    server {
        listen 8994;

        location / {
            root /var/www/hls;
            # Add headers to allow all players to access
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
        }
    }
}
