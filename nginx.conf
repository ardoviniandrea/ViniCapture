events {}

http {
    include /etc/nginx/mime.types;
    access_log /dev/stdout;
    error_log /dev/stderr info;

    types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
    }

    # Upstream for the KasmVNC web server (now running on HTTP)
    upstream kasmvnc {
        server 127.0.0.1:6901;
    }

    server {
        listen 80;
        
        location /api/ {
            proxy_pass http://127.0.0.1:3000;
        }

        # --- FINAL FIX ---
        # Changed proxy_pass to http:// to match the VNC server running without its internal SSL.
        # Nginx is still providing the secure external connection to the user's browser,
        # but the internal connection between Nginx and Xvnc is now plain HTTP.
        location /vnc/ {
            proxy_pass http://kasmvnc/; # Note the trailing slash
            
            # WebSocket proxy settings
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location / {
            root /usr/src/app/public;
            try_files $uri /index.html;
        }
    }

    server {
        listen 8994;

        location / {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
        }
    }
}

