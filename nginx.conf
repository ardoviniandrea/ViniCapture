events {}

http {
    include /etc/nginx/mime.types;

    access_log /dev/stdout;
    error_log /dev/stderr info;

    types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
    }

    # Upstream for the KasmVNC web server
    upstream kasmvnc {
        server 127.0.0.1:6901;
    }

    # Server 1: The All-in-One UI (Port 80)
    server {
        listen 80;
        
        location /api/ {
            proxy_pass http://127.0.0.1:3000;
        }

        # --- DEFINITIVE FIX ---
        # The VNC server is now correctly running WITHOUT SSL, thanks to the
        # override config file created in the Dockerfile.
        # We must now change the proxy_pass to use 'http' to connect to it.
        location /vnc/ {
            # 1. Change proxy_pass to use 'http'
            proxy_pass http://kasmvnc/; # Note the trailing slash
            
            # 2. Remove the unnecessary SSL verification directive
            # proxy_ssl_verify off;

            # WebSocket proxy settings
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Serve the static UI files
        location / {
            root /usr/src/app/public;
            try_files $uri /index.html;
        }
    }

    # Server 2: The HLS Stream (Port 8994)
    server {
        listen 8994;

        location / {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
        }
    }
}
