events {}

http {
    include /etc/nginx/mime.types;

    access_log /dev/stdout;
    error_log /dev/stderr info;

    types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
    }

    # NEW: The 'upstream kasmvnc' block has been removed as it is no longer needed.

    # Server 1: The All-in-One UI (Port 80)
    server {
        listen 80;
        
        # This remains the same, proxying API calls to your Node.js server.
        location /api/ {
            proxy_pass http://127.0.0.1:3000;
        }

        # NEW: This location block proxies the WebSocket connection from the noVNC client
        # to the websockify service, which is listening on port 6901.
        location /websockify {
            proxy_pass http://127.0.0.1:6901/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            # Set a long timeout to prevent the connection from closing during idle periods.
            proxy_read_timeout 86400s; 
        }

        # NEW: This location block serves the static HTML/JS files for the noVNC client.
        # The 'alias' directive maps this URL path to the directory where we installed noVNC.
        location /vnc/ {
            alias /usr/share/novnc/;
            index index.html;
        }

        # This serves your main control panel UI.
        location / {
            root /usr/src/app/public;
            try_files $uri /index.html;
        }
    }

    # Server 2: The HLS Stream (Port 8994) - This remains unchanged.
    server {
        listen 8994;

        location / {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
        }
    }
}
